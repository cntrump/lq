# liquidGlass.metal シェーダーのアーキテクチャ解説

`liquidGlass.metal` シェーダーは、SwiftUIの `layerEffect` を通じて適用される、リアルタイムな液体ガラス効果を生成するためのMetalシェーダーです。このシェーダーは、複数の高度なグラフィックス技術を組み合わせて、屈折、反射、光沢、形状の融合といった視覚効果を実現しています。

## 1. SDF (Signed Distance Function) を用いた形状定義と融合

シェーダーの核となるのは、SDF (Signed Distance Function) を用いた形状の定義と操作です。SDFは、空間内の任意の点から最も近い形状の表面までの距離を符号付きで表現する関数です。距離が正であれば形状の外側、負であれば内側、ゼロであれば表面上にあることを示します。

*   **`sdfRRect` (Rounded Rectangle)**: 角丸長方形のSDFを計算します。
*   **`sdfRect` (Rectangle)**: 長方形のSDFを計算します。
*   **`sdfSquircle` (Squircle)**: スカークル（角が丸まった四角形）のSDFを計算します。これは、通常の角丸よりもさらに滑らかな形状を生成できます。
*   **`sdfEllipse` (Ellipse)**: 楕円のSDFを計算します。

これらの基本的なSDF関数を組み合わせることで、複雑な形状を柔軟に定義できます。

### 形状の融合 (`smoothUnion`)

複数の形状を滑らかに融合するために、`smoothUnion` 関数が使用されています。これは、2つのSDF値とブレンド係数 `k` を用いて、形状の境界を滑らかに結合します。これにより、複数の液体が互いに溶け合うような効果が生まれます。

## 2. 法線計算と3D表現

液体ガラスの表面の光の反射や屈折を正確にシミュレートするためには、各ピクセルにおける表面の法線（Normal）情報が不可欠です。

*   **`dfdx` と `dfdy`**: Metalの組み込み関数である `dfdx` (partial derivative in x) と `dfdy` (partial derivative in y) を使用して、SDFの勾配を計算します。この勾配が表面の法線方向を示します。
*   **`getHeight`**: SDF値と厚み (`thickness`) から、液体の表面の「高さ」を計算します。これにより、液体の立体感や厚みを表現します。

これらの情報を用いて、光の入射角に対する表面の向きを正確に把握し、リアルなライティング効果を適用します。

## 3. リアルなライティング効果

液体ガラスの光沢や透明感を表現するために、複数のライティング技術が組み合わされています。

*   **リムライティング (Fresnel)**: `fresnel` 効果は、視線と表面法線の角度に基づいて、表面の端（リム）が明るく見える現象をシミュレートします。これにより、ガラスの輪郭が強調され、立体感が増します。
*   **スペキュラハイライト (Specular Highlights)**: 光源の方向、視線の方向、表面法線に基づいて、光沢のある表面に現れる明るい点（ハイライト）を計算します。
    *   **`sharpGlint`**: 鋭いハイライトを生成し、ガラスの硬質な光沢を表現します。
    *   **`softBleed`**: 柔らかいハイライトを生成し、内部からの光の滲み出しのような効果を表現します。
*   **環境光 (`ambientStrength`)**: シーン全体の均一な明るさを表現し、影になる部分も完全に暗くならないようにします。

これらのライティング要素を組み合わせることで、液体ガラスの表面が光を反射し、輝く様子をリアルに再現します。

## 4. 屈折と色収差 (Chromatic Aberration)

液体ガラスを通して背景が歪んで見える効果は、光の屈折によって実現されます。

*   **`refract` 関数**: Metalの組み込み関数 `refract` を使用して、光が異なる媒質（空気からガラス、ガラスから空気）を通過する際の方向の変化を計算します。
*   **色収差**: `chromaticAberration` パラメータを調整することで、光の波長（色）によって屈折率がわずかに異なる現象をシミュレートします。これにより、ガラスの端で色が分離して見える、よりリアルな効果が生まれます。赤、緑、青の各チャンネルで異なる屈折率を適用することで、この効果を実現しています。

## 5. Gaussian Blur を用いた背景のぼかし

液体ガラスの背後にある背景をぼかすために、Gaussian Blur アルゴリズムが実装されています。

*   **`applyGaussianBlur`**: この関数は、ガウスカーネルを用いて周囲のピクセルをサンプリングし、重み付けされた平均を計算することで、滑らかなブラー効果を生成します。カーネルサイズ（例: 5x5）を大きくすることで、より高品質なブラーが得られますが、計算負荷は増加します。
*   **サンプリング座標の調整**: `SwiftUI::Layer` から背景をサンプリングする際に、ブラーのオフセットを適用した座標を使用することで、ガラスの内部にある背景がぼやけて見える効果を実現します。

## 6. 色の合成とブレンド

最終的なピクセルの色は、屈折した背景色、ガラスの色、ライティング効果を組み合わせて決定されます。

*   **`applyGlassColor`**: ガラス自体の色 (`glassColor`) を、屈折した背景色にブレンドすることで、色付きのガラスを表現します。
*   **`mix` 関数**: 最終的な色を背景色とブレンドする際に `mix` 関数を使用し、`foregroundAlpha` に基づいて滑らかなトランジションを実現します。

これらの要素技術が連携することで、`liquidGlass.metal` シェーダーは、インタラクティブで視覚的に魅力的な液体ガラス効果をリアルタイムでレンダリングします。
